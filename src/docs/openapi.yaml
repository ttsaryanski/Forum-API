openapi: 3.0.0
info:
    title: Forum REST API
    version: 1.0.0
    description: |
        This API is rate limited:
        - Global: max 100 requests per 15 minutes per IP
        - Endpoint /auth/login: max 5 requests per 15 minutes per IP

servers:
    - url: http://localhost:3000/api

paths:
    /auth/register:
        post:
            summary: User registration
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/AuthRegisterRequest"
            responses:
                201:
                    description: Register is successful
                    headers:
                        Set-Cookie:
                            description: Set JWT in cookie
                            schema:
                                type: string
                                example: refreshToken=eyJhbGciOiJIUzI1...; Path=/; HttpOnly; Secure; SameSite=none
                    content:
                        application/json:
                            example:
                                message: "Registration successful. Please check your email to verify your account!"
                400:
                    description: Bad Request - Invalid data
                    content:
                        application/json:
                            examples:
                                invalidUserName:
                                    summary: Invalid username
                                    value:
                                        message: "Username should be at least 3 characters long!"
                                invalidEmail:
                                    summary: Invalid email
                                    value:
                                        message: "Invalid email format!"
                                invalidPassword:
                                    summary: Invalid password
                                    value:
                                        message: "Password must be at least 6 characters!"
                409:
                    description: Conflict - Username or email already registered
                    content:
                        application/json:
                            examples:
                                usernameExists:
                                    summary: Username already registered
                                    value:
                                        message: "This username already registered!"
                                emailExists:
                                    summary: Email already registered
                                    value:
                                        message: "This email already registered!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error
                    content:
                        application/json:
                            examples:
                                DatabaseError:
                                    summary: Database error
                                    value:
                                        message: "Failed to create user!"
                                EmailServerError:
                                    summary: Email server error
                                    value:
                                        message: "Failed to send verification email!"

    /auth/login:
        post:
            summary: User login
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/AuthLoginRequest"
            responses:
                201:
                    description: Register is successful
                    headers:
                        Set-Cookie:
                            description: Set JWT in cookie
                            schema:
                                type: string
                                example: refreshToken=eyJhbGciOiJIUzI1...; Path=/; HttpOnly; Secure; SameSite=none
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/AuthLoginResponse"
                400:
                    description: Bad Request - Invalid data
                    content:
                        application/json:
                            examples:
                                invalidEmail:
                                    summary: Invalid email
                                    value:
                                        message: "Invalid email format!"
                                invalidPassword:
                                    summary: Invalid password
                                    value:
                                        message: "Password must be at least 6 characters!"
                401:
                    description: Unauthorized - Invalid password
                    content:
                        application/json:
                            example:
                                message: "Password does not match!"
                403:
                    description: Forbidden - email not verified
                    content:
                        application/json:
                            example:
                                message: "Please verify your email first!"
                404:
                    description: Not Found - User does not exist
                    content:
                        application/json:
                            example:
                                message: "User does not exist!"
                429:
                    description: Too Many Requests - Too many login attempts
                    content:
                        application/json:
                            example:
                                message: "Too many login attempts. Please try again in 15 minutes."
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."

    /auth/logout:
        post:
            summary: User logout
            tags: [Auth]
            security:
                - cookieAuth: []
            responses:
                200:
                    description: Logout is successful
                    headers:
                        Set-Cookie:
                            description: Clear JWT cookie
                            schema:
                                type: string
                                example: refreshToken=; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=0
                    content:
                        application/json:
                            example:
                                message: "Logged out successfully!"
                401:
                    description: Unauthorized - Missing or expired token
                    content:
                        application/json:
                            examples:
                                missingToken:
                                    summary: Missing token
                                    value:
                                        message: "Missing refresh token!"
                                invalidToken:
                                    summary: Invalid token
                                    value:
                                        message: "Invalid refresh token!"
                                expiredToken:
                                    summary: Expired token
                                    value:
                                        message: "Refresh token expired, please log in again!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            examples:
                                JWTError:
                                    summary: JWT error
                                    value:
                                        message: "JWT refresh secret is not configured!"
                                ServerError:
                                    summary: General server error
                                    value:
                                        message: "Internal server error..."

    /auth/profile:
        get:
            summary: Gets user profile
            tags: [Auth]
            security:
                - bearerAuth: []
            responses:
                200:
                    description: OK - User profile retrieved successfully
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/SimpleUser"
                401:
                    description: Unauthorized - Missing token
                    content:
                        application/json:
                            examples:
                                missingToken:
                                    summary: Missing token
                                    value:
                                        message: "Missing access token!"
                                invalidToken:
                                    summary: Invalid or expired token
                                    value:
                                        message: "Invalid or expired access token!"
                404:
                    description: Not Found - User does not exist
                    content:
                        application/json:
                            example:
                                message: "There is no user with this id!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."
        post:
            summary: Updates user profile
            tags: [Auth]
            security:
                - bearerAuth: []
            requestBody:
                required: true
                content:
                    multipart/form-data:
                        schema:
                            $ref: "#/components/schemas/AuthProfileEditRequest"
            responses:
                201:
                    description: OK - User profile updated successfully
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/SimpleUser"
                400:
                    description: Bad Request - Invalid data
                    content:
                        application/json:
                            examples:
                                invalidUserName:
                                    summary: Invalid username
                                    value:
                                        message: "Username should be at least 3 characters long!"
                                invalidAvatarFile:
                                    summary: Invalid avatar file type
                                    value: "Only jpeg, jpg, png and gif files are allowed!"
                401:
                    description: Unauthorized - Missing token
                    content:
                        application/json:
                            examples:
                                missingToken:
                                    summary: Missing token
                                    value:
                                        message: "Missing access token!"
                                invalidToken:
                                    summary: Invalid or expired token
                                    value:
                                        message: "Invalid or expired access token!"
                404:
                    description: Not Found - User does not exist
                    content:
                        application/json:
                            example:
                                message: "User not found!"
                409:
                    description: Conflict - Username already taken
                    content:
                        application/json:
                            example:
                                message: "This username is already taken!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."

    /auth/refresh:
        post:
            summary: Refresh access token
            tags: [Auth]
            security:
                - cookieAuth: []
            responses:
                200:
                    description: OK - Access token refreshed successfully
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    accessToken:
                                        type: string
                                        example: eyJhbGciOiJIUzI1...
                401:
                    description: Unauthorized - Invalid or missing refresh token
                    content:
                        application/json:
                            examples:
                                noToken:
                                    summary: No refresh token provided
                                    value:
                                        message: "Missing refresh token!"
                                invalidToken:
                                    summary: Invalid refresh token
                                    value:
                                        message: "Invalid refresh token!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."

    /auth/verify-email/{token}:
        get:
            summary: Verify user email address
            tags: [Auth]
            parameters:
                - in: path
                  name: token
                  required: true
                  schema:
                      type: string
                  description: Email verification token
            responses:
                200:
                    description: OK - Email verified successfully (redirects to client)
                    headers:
                        Location:
                            description: Redirect to client verification success page
                            schema:
                                type: string
                                example: "http://localhost:5173/auth/verified"
                400:
                    description: Bad Request - Missing or invalid token
                    content:
                        application/json:
                            examples:
                                missingToken:
                                    summary: Missing verification token
                                    value:
                                        message: "Verification token is required!"
                                invalidTokenType:
                                    summary: Invalid token type
                                    value:
                                        message: "Invalid token type!"
                                emailAlreadyVerified:
                                    summary: Email already verified
                                    value:
                                        message: "Email is already verified!"
                401:
                    description: Unauthorized - Expired or invalid token
                    content:
                        application/json:
                            examples:
                                expiredToken:
                                    summary: Expired verification token
                                    value:
                                        message: "Verification token has expired. Please request a new verification email."
                                invalidToken:
                                    summary: Invalid verification token
                                    value:
                                        message: "Invalid verification token!"
                404:
                    description: Not Found - User not found
                    content:
                        application/json:
                            example:
                                message: "User not found!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."

    /auth/resend-email:
        post:
            summary: Resend verification email
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/EmailRequest"
            responses:
                200:
                    description: OK - Verification email resent successfully
                    content:
                        application/json:
                            example:
                                message: "Verification email resent. Please check your inbox."
                400:
                    description: Bad Request - Invalid email or already verified
                    content:
                        application/json:
                            examples:
                                invalidEmail:
                                    summary: Invalid email format
                                    value:
                                        message: "Invalid email format!"
                                alreadyVerified:
                                    summary: Email already verified
                                    value:
                                        message: "Email is already verified!"
                404:
                    description: Not Found - User with email does not exist
                    content:
                        application/json:
                            example:
                                message: "User with this email does not exist!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Failed to send verification email!"

    /auth/forgot-password:
        post:
            summary: Send password reset email
            tags: [Auth]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/EmailRequest"
            responses:
                200:
                    description: OK - Password reset email sent successfully
                    content:
                        application/json:
                            example:
                                message: "Verification email sent. Please check your inbox."
                400:
                    description: Bad Request - Invalid email format
                    content:
                        application/json:
                            example:
                                message: "Invalid email format!"
                404:
                    description: Not Found - User with email does not exist
                    content:
                        application/json:
                            example:
                                message: "User with this email does not exist!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Failed to send password reset email!"

    /auth/change-password:
        post:
            summary: Change user password
            tags: [Auth]
            security:
                - bearerAuth: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/ChangePasswordRequest"
            responses:
                200:
                    description: OK - Password changed successfully
                    content:
                        application/json:
                            example:
                                message: "Password changed successfully!"
                400:
                    description: Bad Request - Invalid password format
                    content:
                        application/json:
                            examples:
                                invalidCurrentPassword:
                                    summary: Invalid current password format
                                    value:
                                        message: "Current password should be at least 6 characters long!"
                                invalidNewPassword:
                                    summary: Invalid new password format
                                    value:
                                        message: "New password should be at least 6 characters long!"
                401:
                    description: Unauthorized - Invalid current password or missing token
                    content:
                        application/json:
                            examples:
                                wrongPassword:
                                    summary: Current password is incorrect
                                    value:
                                        message: "Current password is incorrect!"
                                missingToken:
                                    summary: Missing access token
                                    value:
                                        message: "Missing access token!"
                                invalidToken:
                                    summary: Invalid or expired access token
                                    value:
                                        message: "Invalid or expired access token!"
                404:
                    description: Not Found - User not found
                    content:
                        application/json:
                            example:
                                message: "User not found!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."

    /auth/reset-password:
        post:
            summary: Reset password with token
            tags: [Auth]
            parameters:
                - in: query
                  name: token
                  required: true
                  schema:
                      type: string
                  description: Password reset token
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/NewPasswordRequest"
            responses:
                200:
                    description: OK - Password reset successfully
                    content:
                        application/json:
                            example:
                                message: "New password set successfully!"
                400:
                    description: Bad Request - Invalid token type or missing token
                    content:
                        application/json:
                            examples:
                                missingToken:
                                    summary: Missing reset token
                                    value:
                                        message: "Token is required!"
                                invalidTokenType:
                                    summary: Invalid token type
                                    value:
                                        message: "Invalid token type!"
                                invalidPassword:
                                    summary: Invalid password format
                                    value:
                                        message: "Password should be at least 6 characters long!"
                401:
                    description: Unauthorized - Expired or invalid token
                    content:
                        application/json:
                            examples:
                                expiredToken:
                                    summary: Expired reset token
                                    value:
                                        message: "Password reset token has expired. Please request a new password reset."
                                invalidToken:
                                    summary: Invalid reset token
                                    value:
                                        message: "Invalid password reset token!"
                404:
                    description: Not Found - User not found
                    content:
                        application/json:
                            example:
                                message: "No user found to set a new password!"
                429:
                    $ref: "#/components/responses/TooManyRequests"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."

    /news:
        get:
            summary: Gets all news
            tags: [News]
            responses:
                200:
                    description: Ok - Successfully retrieved news
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/GetAllNewsResponse"
                500:
                    description: Internal Server Error - Server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."
        post:
            summary: Creates a new news
            tags: [News]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/CreateNewsRequest"
            responses:
                201:
                    description: Created - news successfully created
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/SimpleNews"
                400:
                    description: Bad Request - invalid data
                    content:
                        application/json:
                            examples:
                                invalidTitle:
                                    summary: Invalid title
                                    value:
                                        message: "News title should be at least 3 characters long!"
                                invalidContent:
                                    summary: Invalid content
                                    value:
                                        message: "News content should be at least 3 characters long!"
                500:
                    description: Internal Server Error - server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."

    /news/{newsId}:
        get:
            summary: Gets a news by ID
            tags: [News]
            parameters:
                - in: path
                  name: newsId
                  required: true
                  schema:
                      type: string
                  description: ID of the news (valid ObjectId - 24 characters)
            responses:
                200:
                    description: Ok - Successfully retrieved news
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/SimpleNews"
                400:
                    description: Bad Request - invalid ID
                    content:
                        application/json:
                            example:
                                message: "Id must be a valid MongooseDB ObjectId!"
                404:
                    description: Not Found - news does not exist
                    content:
                        application/json:
                            example:
                                message: "There is no news with this id!"
                500:
                    description: Internal Server Error - server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."
        put:
            summary: Updates a news by ID
            tags: [News]
            parameters:
                - in: path
                  name: newsId
                  required: true
                  schema:
                      type: string
                  description: ID of the news (valid ObjectId - 24 characters)
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/EditNewsRequest"
            responses:
                201:
                    description: Created - news successfully updated
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/SimpleNews"
                400:
                    description: Bad Request - invalid data
                    content:
                        application/json:
                            examples:
                                invalidId:
                                    summary: Invalid ID
                                    value:
                                        message: "Id must be a valid MongooseDB ObjectId!"
                                invalidTitle:
                                    summary: Invalid title
                                    value:
                                        message: "News title should be at least 3 characters long!"
                                invalidContent:
                                    summary: Invalid content
                                    value:
                                        message: "News content should be at least 3 characters long!"
                404:
                    description: Not Found - news does not exist
                    content:
                        application/json:
                            example:
                                message: "News not found!"
                500:
                    description: Internal Server Error - server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."
        delete:
            summary: Deletes a news by ID
            tags: [News]
            parameters:
                - in: path
                  name: newsId
                  required: true
                  schema:
                      type: string
                  description: ID of the news (valid ObjectId - 24 characters)
            responses:
                204:
                    description: No Content - news successfully deleted
                400:
                    description: Bad Request - invalid ID
                    content:
                        application/json:
                            example:
                                message: "Id must be a valid MongooseDB ObjectId!"
                404:
                    description: Not Found - news does not exist
                    content:
                        application/json:
                            example:
                                message: "News not found!"
                500:
                    description: Internal Server Error - server error
                    content:
                        application/json:
                            example:
                                message: "Internal server error..."

components:
    securitySchemes:
        bearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT

        cookieAuth:
            type: apiKey
            in: cookie
            name: refreshToken
    responses:
        TooManyRequests:
            description: Too many requests
            content:
                application/json:
                    schema:
                        type: object
                        properties:
                            error:
                                type: string
                                example: Too many requests from this IP, please try again later.
    schemas:
        AuthRegisterRequest:
            type: object
            required:
                - username
                - email
                - password
            properties:
                username:
                    type: string
                    example: exampleUser
                email:
                    type: string
                    example: example@email.com
                password:
                    type: string
                    example: examplePassword

        AuthLoginRequest:
            type: object
            required:
                - email
                - password
            properties:
                email:
                    type: string
                    example: example@email.com
                password:
                    type: string
                    example: examplePassword

        AuthLoginResponse:
            type: object
            properties:
                accessToken:
                    type: string
                    example: eyJhbGciOiJIUzI1...

        AuthProfileEditRequest:
            type: object
            required:
                - username
                - email
            properties:
                username:
                    type: string
                    example: mewUsername
                email:
                    type: string
                    format: email
                    description: |
                        User email (immutable, cannot be changed).
                        Must be sent back unchanged by the client.
                    example: example@email.com
                avatarUrl:
                    type: string
                    format: binary
                    nullable: true
                    description: Optional avatar file.

        SimpleUser:
            type: object
            properties:
                id:
                    type: string
                    example: "123"
                email:
                    type: string
                    example: "example@email.com"
                username:
                    type: string
                    example: "exampleUser"
                avatarUrl:
                    type: string
                    example: "https://example.com/avatar.jpg"
                lastLogin:
                    type: string
                    format: date-time
                    example: "2025-05-25T15:04:47.780Z"
                role:
                    type: string
                    example: "user"
                createdAt:
                    type: string
                    format: date-time
                    example: "2025-05-25T15:04:47.780Z"
                updatedAt:
                    type: string
                    format: date-time
                    example: "2025-05-25T15:04:47.780Z"

        EmailRequest:
            type: object
            required:
                - email
            properties:
                email:
                    type: string
                    format: email
                    example: example@email.com

        ChangePasswordRequest:
            type: object
            required:
                - currentPassword
                - newPassword
            properties:
                currentPassword:
                    type: string
                    example: currentPassword123
                    description: User's current password
                newPassword:
                    type: string
                    example: newPassword123
                    description: New password (minimum 6 characters)

        NewPasswordRequest:
            type: object
            required:
                - password
            properties:
                password:
                    type: string
                    example: newPassword123
                    description: New password (minimum 6 characters)

        SimpleNews:
            type: object
            properties:
                _id:
                    type: string
                    example: "6833318fd414ea08fac843ec"
                title:
                    type: string
                    example: "News title"
                content:
                    type: string
                    example: "News content"
                createdAt:
                    type: string
                    format: date-time
                    example: "2025-05-25T15:04:47.780Z"

        GetAllNewsResponse:
            type: array
            items:
                $ref: "#/components/schemas/SimpleNews"

        CreateNewsRequest:
            type: object
            required:
                - title
                - content
            properties:
                title:
                    type: string
                    example: "New news Title"
                content:
                    type: string
                    example: "New news content"

        EditNewsRequest:
            type: object
            required:
                - title
                - content
            properties:
                title:
                    type: string
                    example: "Edited Title"
                content:
                    type: string
                    example: "Edited content"
